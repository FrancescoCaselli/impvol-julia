\documentclass{article}
\usepackage{amsmath}
\begin{document}
Solving a simple Armington-endowment model.

Let $Q_n = A_NL_n$, with $L_n$ completely inelastic. Demand is CES:
\[
C_n^{1-1/\theta} = \sum_m Q_m^{1-1/\theta}.
\]
Trade costs are $\tau_{ij}$ and we denote $\kappa_{ij} = \tau_{ij}^{-\theta}$.

This model has the following equilibrium equations.
\[
d_{nm} = 
	\frac
	{(\tau_{nm}w_m)^{1-\theta}}
	{\sum_k (\tau_{nk} w_k)^{1-\theta}}
\]
\[
w_m \cdot L_m = \sum_n d_{nm} w_n \cdot L_n
\]
where $w_m$ is the unit cost of labor $L_m$.
\[
w_m L_m = w_m^{1-\theta}
\sum_n 	\frac
	{\tau_{nm}^{1-\theta}}
	{\sum_k (\tau_{nk} w_k)^{1-\theta}}
 w_n L_n
\]
Let $\Phi_n = \sum_k (\tau_{nk} w_k)^{1-\theta}$ 
\[
w_m^\theta L_m = 
\sum_n 	
	{\tau_{nm}^{1-\theta}}
 w_n L_n/\Phi_n.
\]
This leads to a better iteration: Pick $w_n$ and calculate corresponding $\Phi_n$. Calculate new $w_n$ from LHS. 

\begin{enumerate}
	\item Pick $\alpha_m^{(0)} = w_mL_m/\Phi_m$ from some previous equilibrium (or data).
	\item Solve for
	\[
	w_m^{(k+1)} = L_m^{-1/\theta} 
		\left[
		\sum_n \alpha_n^{(k)} \tau_{nm}^{1-\theta}
		\right]^{1/\theta}
	\]
	\item Set 
	\[
	\alpha_m^{(k+1)} = w_m^{(k)} L_m/\Phi_m(w^{(k)})
	\]
	and repeat.
\end{enumerate}
This should converge fast, in 3-4 steps, because (i) we start from a close guess, (ii) $\theta$ is large so that $1/\theta$ is small, resulting in dampening, (iii) $\alpha$ has limited impact on wages, only due to destination-country variation in $\tau$, dampening feedback.

\section{Full model}
Introduce a new variable for the factory-gate price of intermediate goods,
\begin{equation}\label{eq:varrho}
	\varrho_{njt} = \xi B_j T_{nj}^{-1/\theta} A_{njt}^{-1} w_{njt}^{\beta_j} \prod_{k=1}^J P_{nkt}^{\gamma_{kj}}.
\end{equation}
With this variable, we can write the price of the final good as
\begin{equation}\label{eq:price}
	P_{mjt} = \left[
		\sum_{n=1}^N (\varrho_{njt}/\kappa_{mnjt})^{-\theta}
		\right]^{-1/\theta}.
\end{equation}
This is a standard CES price index. We can write import shares as
\begin{equation}\label{eq:import_share}
	d_{mnjt} = \left[
	\frac
	{\varrho_{njt}/\kappa_{mnjt}}
	{P_{mjt}}
	\right]^{-\theta}.
\end{equation}
Wages can be expressed by inverting \eqref{eq:varrho},
\begin{equation}\label{eq:wage}
	w_{njt} = (\xi B_j)^{-1/\beta_j}
	\varrho_{njt}^{1/\beta_j}  
	T_{nj}^{1/(\beta_j\theta)}A_{njt}^{1/\beta_j} 
	\prod_{k=1}^J P_{nkt}^{-\gamma_{kj}/\beta_j}.
\end{equation}

Taking the market clearing condition,
\begin{equation}
	R_{njt} = \sum_{m=1}^N
		d_{mnjt}
		\left[
			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt} - S_{mt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}
		\right],
\end{equation}
\[
	R_{njt}\varrho_{njt}^{\theta} = \sum_{m=1}^N
		(\kappa_{mnjt} P_{mjt})^{\theta}
		\left[
			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt} - S_{mt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}
		\right],
\]
\begin{equation}\label{eq:market_clearing}
	\varrho_{njt} = R_{njt}^{-1/\theta}
	\left\{
	\sum_{m=1}^N
		(\kappa_{mnjt} P_{mjt})^{\theta}
		\left[
			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt} - S_{mt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}
		\right]
	\right\}^{1/\theta}.
\end{equation}
Here both $R_{njt}$ and $\varrho_{njt}$ depend on equilibrium prices. But starting from a guess for $R$ (say, the autarky equilibrium), we can easily compute a shadow price $\varrho$ supporting that allocation. 
\begin{enumerate}
	\item Set $R_{njt}^{(0)}$ and $P_{njt}^{(0)}$ to the autarky equilibrium value or other suitable starting value.
	\item Given $R_{njt}^{(k)}$ and $P_{njt}^{(k)}$, solve for $\varrho_{njt}^{(k+1)}$ using equation \eqref{eq:market_clearing}.
	\item Solve for $w_{njt}^{(k+1)}$ and $P_{njt}^{(k+1)}$ using \eqref{eq:wage} and \eqref{eq:price}.
	\item Calculate $R_{njt}^{(k+1)} = w_{njt}^{(k+1)}L_{njt}/\beta_j$. (This step sounds the most divergent, nothing ensures that relative sectoral revenue shares will remain close to equilibrium.)
	\item Go back to Step 2 and repeat until convergence.
\end{enumerate}
Typically, this converges in 4--6 steps. This might even be a contraction mapping. 

\begin{equation*}
	\varrho_{njt}/P_{njt} = 
	\left\{
	\sum_{m=1}^N
		(\kappa_{nmjt} P_{mjt}/P_{njt})^{\theta}
		\left[
			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt}/R_{njt} - S_{mt}/R_{njt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}/R_{njt}
		\right]
	\right\}^{1/\theta}.
\end{equation*}


\subsection{Dual loop}
What are the sectoral expenditures across countries?
\[
E_{mjt} = 			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt} - S_{mt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}
\]
The sectoral expenditure share is
\begin{equation}\label{eq:sectoral_share}
e_{mjt} = \frac
	{\sum_{k=1}^J(\alpha_{jt}\beta_k+\gamma_{jk}) R_{mkt} - S_{mt}}
	{\sum_{k=1}^J R_{mkt}-S_{mt}}.
\end{equation}
Even if $S_{mt}=0$, this is not constant, because it depends on the revenue distribution across sectors. If a country has a comparative advantage in car production, it will have high revenue (not expenditure) in cars. But then it will have high expenditure in car inputs. 

For the purposes of finding the equilibrium, fix sectoral expenditure shares in each country. (We can start from free-trade expenditure shares, which are exogenous and are the same across countries.) Rewriting the equilibrium condition,
\[
	\varrho_{njt} = R_{njt}^{-1/\theta}
	\left[
	\sum_{m=1}^N
		(\kappa_{mnjt} P_{mjt})^{\theta}
		e_{mjt}
		\left(
			\sum_{k=1}^J R_{mkt}
			-S_{mt}
		\right)
	\right]^{1/\theta}.
\]
Inner loop: solve for $\varrho$ and $R$, holding $e$ fixed. This does not allow for divergence across sectors off the equilibrium path, as the sectoral composition is held fixed.

Middle loop: given the solved $R$s, calculate the new expenditure shares from equation \eqref{eq:sectoral_share}. This may be dampened. 

\subsection{Suitable starting values}
Suppose that trade is free, $\kappa_{nmjt}\equiv 1$. Then $P_{njt}\equiv P_{jt}$ and
\begin{equation*}
	\varrho_{njt}^{(0)} = 
	P_{jt}
	R_{njt}^{-1/\theta}
	\left\{
	\sum_{m=1}^N
		\left[
			\alpha_{jt}
			\left(
				\sum_{k=1}^J\beta_k R_{mkt} - S_{mt}
			\right)
			+ \sum_{k=1}^J\gamma_{jk}R_{mkt}
		\right]
	\right\}^{1/\theta}.
\end{equation*}
Let $R_{wjt}$ denote the world revenue in sector $j$.
\begin{equation*}
	\varrho_{njt}^{(0)} = 
	P_{jt}
	R_{njt}^{-1/\theta}
		\left[
				\sum_{k=1}^J
				(\alpha_{jt}\beta_k + \gamma_{jk}) R_{wkt}
		\right]^{1/\theta}.
\end{equation*}
This only determines $\varrho_{njt}/P_{jt}$, what determines $P_{jt}$ relative to other sectors?\begin{equation*}
	\varrho_{njt}/P_{jt} = 
	\beta_j^{1/\theta}
	(w_{njt}L_{njt})^{-1/\theta}
		\left[
				\sum_{k=1}^J
				(\alpha_{jt} + \gamma_{jk}/\beta_k) 
				\sum_{m=1}^N w_{mkt}L_{mkt}
		\right]^{1/\theta}.
\end{equation*}
Sum across $n$s,
\begin{equation*}
	(\varrho_{njt}/P_{jt})^{-\theta} = 
	\beta_j^{-1}
	(w_{njt}L_{njt})
		\left[
				\sum_{k=1}^J
				(\alpha_{jt} + \gamma_{jk}/\beta_k) 
				\sum_{m=1}^N w_{mkt}L_{mkt}
		\right]^{-1}.
\end{equation*}
\begin{equation*}
	w_{wjt}L_{wjt}
	= \beta_j
				\sum_{k=1}^J
				(\alpha_{jt} + \gamma_{jk}/\beta_k) 
				w_{wkt}L_{wkt}.
\end{equation*}
\begin{equation*}
	R_{wjt}
	=
			\sum_{k=1}^J
			(\alpha_{jt}\beta_k + \gamma_{jk}) 
			R_{wkt}.
\end{equation*}
We can solve this for eigenvalue equation for $R_{wjt}$ without knowing anything about equilibrium prices, conditional a global numeraire.


Write the log of equation \eqref{eq:varrho} in matrix notation, and recognizing that under free trade, $P$ does not depend on $n$,
\[
\ln\mathbf \varrho_{nt} = \ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
	+ \text{diag}(\beta) \ln\mathbf w_{nt}
	+ \Gamma \ln\mathbf P_{t}  
\]
\[
\ln\mathbf \varrho_{nt} - \ln\mathbf P_{t} 
 = \frac1\theta\ln\mathbf\beta
 	-\frac1\theta(\ln \mathbf w_{nt}+ \ln \mathbf L_{nt})
 	+\frac1\theta \ln \mathbf E_{wt}
\]
\[
\frac1\theta\ln\mathbf\beta
 	-\frac1\theta(\ln \mathbf w_{nt}+ \ln \mathbf L_{nt})
 	+\frac1\theta \ln \mathbf E_{wt}
=
\ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
	+ \text{diag}(\beta) \ln\mathbf w_{nt}
	+ (\Gamma-\mathbf I) \ln\mathbf P_{t}
\]
\[
\ln\mathbf\beta
 	-\ln \mathbf L_{nt}
 	+ \ln \mathbf E_{wt}
	+ \theta\ln\mathbf A_{nt}
	-\theta\ln\xi
	- \theta\ln\mathbf B
	+ \theta(\mathbf I-\Gamma) \ln\mathbf P_{t}
=
	 \text{diag}(1+\beta\theta) \ln\mathbf w_{nt}
\]
Guess a $P$. Solve above for $w$. Then solve for next $P$.
\subsubsection{General problem for free trade}
Pricing equation:
\[
\ln\mathbf \varrho_{nt}-\ln\mathbf P_{t} = 
\ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
+\text{diag}(\beta)(\ln\mathbf w_{nt}-\ln\mathbf P_{t})
+ \mathbf C \ln\mathbf P_{t}  
\]
The last matrix $\mathbf C = \Gamma+\text{diag}(\beta)-\mathbf I$ has the property $\mathbf C\mathbf 1=\mathbf 0$ so this equation is hom(0) in prices. 

Import share equation:
\[
\ln\mathbf \varrho_{nt} - \ln\mathbf P_{t} 
 = 
 	+\frac1\theta(\ln\mathbf\beta+\ln \mathbf E_{wt}-\ln \mathbf w_{nt}- \ln \mathbf L_{nt})
\]
This is also hom(0) in prices. World expenditure $E_{wt}$ can be precomputed up to a choice of numeraire.

CES price index:
\[
\ln\mathbf P_{t} = -\frac1\theta
 \ln \left[
 	\sum_{n=1}^N \exp(-\theta \ln \varrho_{nt})
 \right]
\]
\[
\mathbf 1 =  
 	\sum_{n=1}^N \exp[-\theta (\ln \varrho_{nt}-\ln\mathbf P_{t})]
\]
Again, hom(0) in prices. Substituting in the import share equation,
\[
\mathbf 1 =  
 	\sum_{n=1}^N \exp(\ln\mathbf w_{nt}-\ln\mathbf E_{wt}-\theta\mathbf b_2).
\]
This just says that the import shares add up to 1. This suggests that we can limit the search to import shares on the simplex. Let $\mathbf d_{nt}$ denote the import share vector.
\[
\ln\mathbf \varrho_{nt} - \ln\mathbf P_{t} 
 = -\frac1\theta \ln\mathbf d_{nt}
\]
Wages are
\[
\ln\mathbf w_{nt} = \ln\beta+\ln\mathbf d_{nt}+\ln\mathbf E_{wt}-\ln\mathbf L_{nt}
\]
so that
\[
-\frac1\theta \ln\mathbf d_{nt} = 
\ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
+
\text{diag}(\beta)(\ln\beta+\ln\mathbf d_{nt}-\ln\mathbf L_{nt}+\ln\mathbf E_{wt})
- (\mathbf I-\Gamma) \ln\mathbf P_{t}  
\]
\[
\text{diag}(\beta+1/\theta) \ln\mathbf d_{nt} = 
-\ln\xi
	- \ln\mathbf B
	+ \ln\mathbf A_{nt}
+
\text{diag}(\beta)(\ln\mathbf L_{nt}-\ln\mathbf E_{wt})
+ (\mathbf I-\Gamma) \ln\mathbf P_{t}  
\]
This holds for all $n$ and $t$. In particular, it also holds for country $0$, which we can subtract:
\[
\text{diag}(\beta+1/\theta) (\ln\mathbf d_{nt}-\ln\mathbf d_{0t}) = 
	\ln\mathbf A_{nt}-\ln\mathbf A_{0t}
+
\text{diag}(\beta)(\ln\mathbf L_{nt}-\ln\mathbf L_{0t})
\]
\[
(\ln\mathbf d_{nt}-\ln\mathbf d_{0t}) = 
	\text{diag}(\theta/(1+\beta\theta)) (\ln\mathbf A_{nt}-\ln\mathbf A_{0t})
+
\text{diag}(\beta\theta/(1+\beta\theta))(\ln\mathbf L_{nt}-\ln\mathbf L_{0t})
\]
This suggests the following solution for import shares,
\[
d_{njt} = c_{jt}A_{njt}^{\theta/(1+\beta_j\theta)}L_{njt}^{\beta_j\theta/(1+\beta_j\theta)},
\]
where the $c_{jt}$ constant is such that import shares add up to 1 for all $j$ and all $t$.

Given $d_{njt}$ and the precomputed $E_{wjt}$, we can calculate wages in all sectors. Prices can be calculated from
\[
\ln\mathbf P_{t} = 
(\mathbf I-\Gamma)^{-1}[\text{diag}(\beta+1/\theta) \ln\mathbf d_{0t}  
+\ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{0t}
+
\text{diag}(\beta)(\ln\mathbf E_{wt}-\ln\mathbf L_{0t})]
 .  
\]


\subsubsection{Autarky}
Suppose that each country is in autarky, $\kappa_{nmjt}\equiv 0$ for all $n\neq m$ and 1 otherwise, and $S_{nt}\equiv 0$. Then $P_{njt}=\varrho_{njt}$ and 
\begin{equation*}
	R_{njt} = 			
		\sum_{k=1}^J(\alpha_{jt}\beta_k+\gamma_{jk}) R_{nkt}. 
\end{equation*}
Solving the eigenvalue equation
\[
\mathbf R_{nt} = (\mathrm\alpha_t \mathbf \beta'+\Gamma)\mathbf R_{nt}
\]
pins down $R_{njt}$ up to a scale parameter $\omega_{nt}$ and we can easily solve for wages, again up to the same scale parameter. Note that this only depends on fixed parameters, so we can pre-calculate autarky wages.

$\omega_{nt}R_{njt}$, $\omega_{nt}w_{njt}$

Write the log of equation \eqref{eq:varrho} in matrix notation and recognizing $\varrho_{njt}\equiv P_{njt}$ in autarky,
\[
\ln\mathbf P_{nt} = \ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
	+ \text{diag}(\beta) \ln\mathbf w_{nt}
	+ \Gamma \ln\mathbf P_{nt}  
\]
\[
\ln\mathbf P_{nt} = 
(\mathbf I-\Gamma)^{-1}
	[
	\ln\xi
	+ \ln\mathbf B
	- \ln\mathbf A_{nt}
	+ \text{diag}(\beta) \ln\mathbf w_{nt}
	]
\]
This gives us prices up to the same scale parameter. Again, everything can be precalculated and the only part that varies across simulations is
\[
\Delta \ln\mathbf P_{nt}
-(\mathbf I-\Gamma)^{-1}
	\Delta\ln\mathbf A_{nt}.
\]
We still need to find suitable starting values for $\omega_{nt}$. We can use the overall GDP shares in the data 
\[
\omega_{nt} = c\cdot Y_{nt}^{-1/\theta}.
\]
This can also be precalculated.

\end{document}